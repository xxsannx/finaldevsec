version: '3.8'

services:
    # 1. Laravel Application Service
    app:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: pineus_tilu_app
        restart: unless-stopped
        working_dir: /var/www
        volumes:
            - ./:/var/www
            - ./docker/php/local.ini:/usr/local/etc/php/conf.d/local.ini
        networks:
            - pineus_network
        depends_on:
            - mysql
            - redis
        environment:
            # Database and Cache configuration
            - DB_HOST=mysql
            - DB_PORT=3306
            - DB_DATABASE=pineus_tilu
            - DB_USERNAME=pineus_user
            - DB_PASSWORD=pineus_secret
            - REDIS_HOST=redis
            - REDIS_PORT=6379

    # 2. Nginx Web Server Service
    nginx:
        image: nginx:alpine
        container_name: pineus_tilu_nginx
        restart: unless-stopped
        ports:
            - "8000:80"
        volumes:
            - ./:/var/www
            - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
        networks:
            - pineus_network
        depends_on:
            - app

    # 3. MySQL Database Service
    mysql:
        image: mysql:8.0
        container_name: pineus_tilu_mysql
        restart: unless-stopped
        ports:
            - "3307:3306"
        environment:
            MYSQL_DATABASE: pineus_tilu
            MYSQL_USER: pineus_user
            MYSQL_PASSWORD: pineus_secret
            MYSQL_ROOT_PASSWORD: root_secret
        volumes:
            - mysql_data:/var/lib/mysql
            - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf
        networks:
            - pineus_network
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
            interval: 10s
            timeout: 5s
            retries: 5

    # 4. Redis Cache Service
    redis:
        image: redis:7-alpine
        container_name: pineus_tilu_redis
        restart: unless-stopped
        ports:
            - "6380:6379"
        volumes:
            - redis_data:/data
        networks:
            - pineus_network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 3s
            retries: 5

    # 5. SonarQube CI/CD Service
    sonarqube:
        image: sonarqube:community
        container_name: pineus_tilu_sonarqube
        restart: unless-stopped
        ports:
            - "9000:9000"
        environment:
            - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
        volumes:
            - sonarqube_data:/opt/sonarqube/data
            - sonarqube_extensions:/opt/sonarqube/extensions
            - sonarqube_logs:/opt/sonarqube/logs
        networks:
            - pineus_network

    # 6. Jenkins CI Server Service
    jenkins:
        image: jenkins/jenkins:lts
        privileged: true
        user: root 
        container_name: pineus_tilu_jenkins
        restart: unless-stopped
        ports:
            - "8080:8080" 
            - "50000:50000"
        volumes:
            - jenkins_home:/var/jenkins_home
            - /var/run/docker.sock:/var/run/docker.sock # Docker-in-Docker setup
            - /usr/bin/docker:/usr/bin/docker
            - ./:/var/jenkins_home/workspace/laravel-project 
        networks:
            - pineus_network
        environment:
            - TZ=Asia/Jakarta
        depends_on:
            - sonarqube

    # 7. Prometheus Monitoring Service
    prometheus:
        image: prom/prometheus:latest
        container_name: pineus_tilu_prometheus
        restart: unless-stopped
        ports:
            - "9090:9090"
        volumes:
            - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus_data:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
        networks:
            - pineus_network

    # 8. Grafana Dashboard Service
    grafana:
        image: grafana/grafana:latest
        container_name: pineus_tilu_grafana
        restart: unless-stopped
        ports:
            - "3000:3000"
        environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=admin123
            - GF_USERS_ALLOW_SIGN_UP=false
        volumes:
            - grafana_data:/var/lib/grafana
            - ./docker/grafana/provisioning:/etc/grafana/provisioning
        networks:
            - pineus_network
        depends_on:
            - prometheus

    # 9. Node Exporter System Metrics Service
    node_exporter:
        image: prom/node-exporter:latest
        container_name: pineus_tilu_node_exporter
        restart: unless-stopped
        ports:
            - "9100:9100"
        command:
            - '--path.rootfs=/host'
        volumes:
            - /:/host:ro,rslave
        networks:
            - pineus_network

    # 10. Locust Load Testing Service (Traffic Generation)
    locust:
        image: locustio/locust
        container_name: pineus_tilu_locust
        # Port 8089 digunakan untuk mengakses Web UI Locust (Opsional, hanya untuk manual run)
        ports:
            - "8089:8089" 
        volumes:
            - ./docker/locust/locustfile.py:/home/locust/locustfile.py
        networks:
            - pineus_network
        environment:
            - TARGET_HOST=http://nginx:80
        depends_on:
            - nginx

    # 11. OWASP ZAP Security Scanning Service
    zap:
        image: zaproxy/zap-stable
        container_name: pineus_tilu_zap
        restart: unless-stopped
        ports:
            - "8090:8080"
            - "8091:8090" 
        command: zap-webswing.sh 
        networks:
            - pineus_network

networks:
    pineus_network:
        driver: bridge

volumes:
    mysql_data:
        driver: local
    redis_data:
        driver: local
    sonarqube_data:
        driver: local
    sonarqube_extensions:
        driver: local
    sonarqube_logs:
        driver: local
    prometheus_data:
        driver: local
    grafana_data:
        driver: local
    jenkins_home:
        driver: local